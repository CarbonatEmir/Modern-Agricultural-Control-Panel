{% extends 'base.html' %}

{% block title %}G√∂r√ºnt√º Analizi - SeraVision{% endblock %}

{% block content %}
<style>
    .upload-area {
        border: 2px dashed #cbd5e1; border-radius: 12px; padding: 50px 20px;
        text-align: center; cursor: pointer; background-color: #f8fafc;
        transition: all 0.3s ease; margin-bottom: 20px;
    }
    .upload-area:hover { border-color: #4ade80; background-color: #f0fdf4; }
    .preview-container { display: none; margin-bottom: 20px; }
    
    .image-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; }
    .image-grid img { 
        width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: zoom-in; transition: transform 0.2s;
    }
    .image-grid img:hover { transform: scale(1.05); }
    
    .video-preview { width: 100%; max-height: 400px; border-radius: 8px; background: #000; }
    .btn-detect {
        background-color: #2e7d32; color: white; border: none; padding: 15px;
        font-size: 16px; font-weight: bold; border-radius: 8px; cursor: pointer;
        width: 100%; display: none; transition: background-color 0.3s;
    }
    .btn-detect:hover { background-color: #1b5e20; }
    
    .loading-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(15, 23, 42, 0.85); z-index: 9999;
        justify-content: center; align-items: center; flex-direction: column; color: white;
    }
    .spinner {
        border: 5px solid rgba(255,255,255,0.2); border-top: 5px solid #4ade80;
        border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin-bottom: 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .pagination-controls {
        display: none; justify-content: center; align-items: center; gap: 20px; margin-top: 20px;
    }
    .btn-page {
        background-color: #334155; color: white; border: none; padding: 8px 16px;
        border-radius: 6px; cursor: pointer; transition: background 0.3s; font-weight: bold;
    }
    .btn-page:hover:not(:disabled) { background-color: #4ade80; color: #0f172a; }
    .btn-page:disabled { opacity: 0.5; cursor: not-allowed; }
    .page-indicator { font-weight: bold; color: var(--text-muted); }

    .result-modal {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(15, 23, 42, 0.7); z-index: 10000;
        justify-content: center; align-items: center; backdrop-filter: blur(5px);
    }
    .result-card {
        background: white; border-radius: 16px; padding: 40px; width: 90%; max-width: 500px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); text-align: center;
        transform: translateY(20px); animation: slideUp 0.4s ease forwards;
    }
    @keyframes slideUp { to { transform: translateY(0); } }
    
    .result-title { font-size: 24px; font-weight: bold; color: #0f172a; margin-bottom: 25px; }
    .result-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
    .stat-box { background: #f8fafc; padding: 20px 15px; border-radius: 12px; border: 1px solid #e2e8f0; }
    .stat-box.ham { border-left: 4px solid #84cc16; }
    .stat-box.yari { border-left: 4px solid #f59e0b; }
    .stat-box.olgun { border-left: 4px solid #ef4444; }
    .stat-box.ort { border-left: 4px solid #3b82f6; grid-column: span 2; }
    .stat-label { font-size: 13px; color: #64748b; text-transform: uppercase; font-weight: bold; letter-spacing: 0.5px; }
    .stat-val { font-size: 32px; font-weight: bold; color: #0f172a; margin-top: 8px; }
    
    .btn-close-modal {
        background: #e2e8f0; color: #0f172a; border: none; padding: 12px 24px;
        border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; width: 100%; font-size: 16px;
    }
    .btn-close-modal:hover { background: #cbd5e1; }
    
    .ai-results-widget {
        display: none;
        margin-top: 30px;
    }
    
    .processed-image-grid {
        display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;
    }
    .processed-image-grid img {
        width: 100%; aspect-ratio: 16/9; object-fit: cover; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        border: 2px solid #4ade80; cursor: zoom-in; transition: transform 0.2s;
    }
    .processed-image-grid img:hover { transform: scale(1.03); }

    .lightbox-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.9); z-index: 20000;
        justify-content: center; align-items: center; backdrop-filter: blur(5px);
    }
    .lightbox-img {
        max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .lightbox-close {
        position: absolute; top: 20px; right: 30px; font-size: 40px; color: white;
        cursor: pointer; transition: color 0.3s;
    }
    .lightbox-close:hover { color: #4ade80; }
</style>

<header>
    <h1>Sera Analizini Ba≈ülat</h1>
    <div style="color: var(--text-muted); font-weight: 500;">Fotoƒüraf veya Video Y√ºkle</div>
</header>

<div class="dashboard-container">
    <div class="widget">
        <div class="widget-title">Analiz Edilecek Dosyalarƒ± Se√ßin</div>
        <input type="file" id="fileInput" accept="image/*,video/*" multiple style="display: none;">
        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
            <div style="font-size: 48px; margin-bottom: 10px;">üì•</div>
            <h2>Tƒ±klayƒ±n veya Dosyalarƒ± S√ºr√ºkleyin</h2>
            <p style="color: var(--text-muted); margin-top: 5px;">Aynƒ± anda birden fazla fotoƒüraf veya 1 adet video y√ºkleyebilirsiniz.</p>
        </div>
        
        <div class="preview-container" id="previewContainer">
            <div class="image-grid" id="imageGrid"></div>
            <div id="videoContainer"></div>
            
            <div class="pagination-controls" id="paginationControls">
                <button class="btn-page" id="btnPrev">√ñnceki</button>
                <span class="page-indicator" id="pageIndicator">Sayfa 1 / 1</span>
                <button class="btn-page" id="btnNext">Sonraki</button>
            </div>
        </div>
        
        <button class="btn-detect" id="btnDetect" style="margin-top: 15px;">G√∂r√ºnt√ºy√º Analiz Et</button>
    </div>

    <div class="widget ai-results-widget" id="aiResultsWidget">
        <div class="widget-title">Yapay Zeka Analiz Sonu√ßlarƒ± (ƒ∞≈ülenmi≈ü G√∂r√ºnt√ºler)</div>
        <div class="processed-image-grid" id="processedImagesGrid"></div>
        
        <div class="pagination-controls" id="resultPaginationControls">
            <button class="btn-page" id="btnResPrev">√ñnceki</button>
            <span class="page-indicator" id="resPageIndicator">Sayfa 1 / 1</span>
            <button class="btn-page" id="btnResNext">Sonraki</button>
        </div>
    </div>
</div>

<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <h2 style="margin-bottom: 10px;">YOLO Modeli √áalƒ±≈üƒ±yor...</h2>
    <p style="color: #cbd5e1;">G√∂r√ºnt√º i≈üleniyor, l√ºtfen bekleyin.</p>
</div>

<div class="result-modal" id="resultModal">
    <div class="result-card">
        <div style="font-size: 56px; margin-bottom: 15px;">üçÖ</div>
        <div class="result-title">Analiz Ba≈üarƒ±yla Tamamlandƒ±!</div>
        
        <div class="result-stats">
            <div class="stat-box ham">
                <div class="stat-label">Ham Domates</div>
                <div class="stat-val" id="resHam">0</div>
            </div>
            <div class="stat-box yari">
                <div class="stat-label">Yarƒ± Olgun</div>
                <div class="stat-val" id="resYari">0</div>
            </div>
            <div class="stat-box olgun">
                <div class="stat-label">Olgun Domates</div>
                <div class="stat-val" id="resOlgun">0</div>
            </div>
            <div class="stat-box ort">
                <div class="stat-label">Sera Olgunluk Oranƒ±</div>
                <div class="stat-val" id="resOrt">%0</div>
            </div>
        </div>
        
        <button class="btn-close-modal" onclick="document.getElementById('resultModal').style.display='none'">Kapat ve G√∂r√ºnt√ºleri ƒ∞ncele</button>
    </div>
</div>

<div class="lightbox-overlay" id="lightboxOverlay" onclick="this.style.display='none'">
    <span class="lightbox-close">&times;</span>
    <img class="lightbox-img" id="lightboxImg" src="" alt="Tam Boyut" onclick="event.stopPropagation()">
</div>

{% endblock content %}

{% block scripts %}
<script>
    const fileInput = document.getElementById('fileInput');
    const previewContainer = document.getElementById('previewContainer');
    const imageGrid = document.getElementById('imageGrid');
    const videoContainer = document.getElementById('videoContainer');
    const btnDetect = document.getElementById('btnDetect');
    const loadingOverlay = document.getElementById('loadingOverlay');
    
    const paginationControls = document.getElementById('paginationControls');
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    const pageIndicator = document.getElementById('pageIndicator');

    const resultModal = document.getElementById('resultModal');
    const resHam = document.getElementById('resHam');
    const resYari = document.getElementById('resYari');
    const resOlgun = document.getElementById('resOlgun');
    const resOrt = document.getElementById('resOrt');
    
    const aiResultsWidget = document.getElementById('aiResultsWidget');
    const processedImagesGrid = document.getElementById('processedImagesGrid');
    const resultPaginationControls = document.getElementById('resultPaginationControls');
    const btnResPrev = document.getElementById('btnResPrev');
    const btnResNext = document.getElementById('btnResNext');
    const resPageIndicator = document.getElementById('resPageIndicator');

    const lightboxOverlay = document.getElementById('lightboxOverlay');
    const lightboxImg = document.getElementById('lightboxImg');

    let uploadedImages = []; 
    let currentPage = 1;
    const imagesPerPage = 5; 
    
    let processedImages = [];
    let currentResultPage = 1;
    const resultsPerPage = 6;

    window.openLightbox = function(src) {
        lightboxImg.src = src;
        lightboxOverlay.style.display = 'flex';
    };

    function renderImagePage() {
        imageGrid.innerHTML = ''; 
        const startIndex = (currentPage - 1) * imagesPerPage;
        const endIndex = startIndex + imagesPerPage;
        const imagesToShow = uploadedImages.slice(startIndex, endIndex);

        imagesToShow.forEach(url => {
            imageGrid.innerHTML += `<img src="${url}" alt="Sera √ñnizleme" onclick="openLightbox(this.src)">`;
        });

        const totalPages = Math.ceil(uploadedImages.length / imagesPerPage);
        pageIndicator.innerText = `Sayfa ${currentPage} / ${totalPages}`;

        btnPrev.disabled = currentPage === 1;
        btnNext.disabled = currentPage === totalPages;
    }

    function renderResultPage() {
        processedImagesGrid.innerHTML = '';
        const startIndex = (currentResultPage - 1) * resultsPerPage;
        const endIndex = startIndex + resultsPerPage;
        const imagesToShow = processedImages.slice(startIndex, endIndex);

        imagesToShow.forEach(imgBase64 => {
            processedImagesGrid.innerHTML += `<img src="${imgBase64}" alt="AI ƒ∞≈ülenmi≈ü G√∂r√ºnt√º" onclick="openLightbox(this.src)">`;
        });

        const totalPages = Math.ceil(processedImages.length / resultsPerPage) || 1;
        resPageIndicator.innerText = `Sayfa ${currentResultPage} / ${totalPages}`;

        btnResPrev.disabled = currentResultPage === 1;
        btnResNext.disabled = currentResultPage === totalPages;

        if (processedImages.length > resultsPerPage) {
            resultPaginationControls.style.display = 'flex';
        } else {
            resultPaginationControls.style.display = 'none';
        }
    }

    btnPrev.addEventListener('click', () => {
        if (currentPage > 1) { 
            currentPage--; 
            renderImagePage(); 
        }
    });

    btnNext.addEventListener('click', () => {
        const totalPages = Math.ceil(uploadedImages.length / imagesPerPage);
        if (currentPage < totalPages) { 
            currentPage++; 
            renderImagePage(); 
        }
    });

    btnResPrev.addEventListener('click', () => {
        if (currentResultPage > 1) {
            currentResultPage--;
            renderResultPage();
        }
    });

    btnResNext.addEventListener('click', () => {
        const totalPages = Math.ceil(processedImages.length / resultsPerPage);
        if (currentResultPage < totalPages) {
            currentResultPage++;
            renderResultPage();
        }
    });

    fileInput.addEventListener('change', function() {
        imageGrid.innerHTML = '';
        videoContainer.innerHTML = '';
        paginationControls.style.display = 'none';
        aiResultsWidget.style.display = 'none';
        processedImagesGrid.innerHTML = '';
        resultPaginationControls.style.display = 'none';
        
        uploadedImages = [];
        processedImages = [];
        currentPage = 1;
        currentResultPage = 1;

        const files = this.files;
        if (files.length === 0) return;
        
        previewContainer.style.display = 'block';
        btnDetect.style.display = 'block';

        const firstFileType = files[0].type;
        
        if (firstFileType.startsWith('video/')) {
            const videoUrl = URL.createObjectURL(files[0]);
            videoContainer.innerHTML = `<video class="video-preview" controls src="${videoUrl}"></video>`;
        } else if (firstFileType.startsWith('image/')) {
            Array.from(files).forEach(file => {
                uploadedImages.push(URL.createObjectURL(file));
            });

            if (uploadedImages.length > imagesPerPage) {
                paginationControls.style.display = 'flex';
            }

            renderImagePage();
        }
    });

    btnDetect.addEventListener('click', function() {
        const files = fileInput.files;
        if (files.length === 0) { 
            alert("L√ºtfen √∂nce bir dosya se√ßin!"); 
            return; 
        }

        loadingOverlay.style.display = 'flex';

        const formData = new FormData();
        
        for (let i = 0; i < files.length; i++) {
            formData.append('files', files[i]);
        }

        fetch('/api/analiz-yap/', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            loadingOverlay.style.display = 'none'; 
            
            if (data.status === 'success') {
                resHam.innerText = data.sonuclar.ham;
                resYari.innerText = data.sonuclar.yari;
                resOlgun.innerText = data.sonuclar.olgun;
                resOrt.innerText = "%" + data.sonuclar.ortalama;
                
                if (data.sonuclar.gorseller && data.sonuclar.gorseller.length > 0) {
                    processedImages = data.sonuclar.gorseller;
                    currentResultPage = 1;
                    renderResultPage();
                    aiResultsWidget.style.display = 'block';
                }
                
                resultModal.style.display = 'flex';
            } else {
                alert("Hata olu≈ütu: " + data.mesaj);
            }
        })
        .catch(error => {
            loadingOverlay.style.display = 'none';
            alert("Sunucuya baƒülanƒ±rken hata olu≈ütu.");
            console.error(error);
        });
    });
</script>
{% endblock scripts %}